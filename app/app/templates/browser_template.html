<!-- browser.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8">
    <title>CoExPlore Browser</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <!-- Additional DataTables CSS files -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css">

    <!-- Custom CSS -->
    <style>
        /* Remove all borders from the table */
        table.display.no-border,
        table.display.no-border thead,
        table.display.no-border tbody,
        table.display.no-border th,
        table.display.no-border td,
        table.display.no-border tr {
            border: none !important;
            border-collapse: collapse !important;
        }

        table.display.no-border th,
        table.display.no-border td {
            border-bottom: none !important;
        }

        /* Remove the default top border from DataTables */
        table.display.no-border {
            border-top: none !important;
        }

        /* Remove background colors from table headers */
        table.display.no-border thead th {
            background-color: transparent !important;
        }

        /* Remove borders from the card */
        .card {
            border: none !important;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-body">
            <table id="browserRes" class="display responsive nowrap no-border" style="width:100%; display:none;">
                <thead>
                    <tr>
                        <th>Species</th>
                        <th>Transcript</th>
                        <th>Module Colors</th>
                        <th>Module Labels</th>
                        <th>GO Terms</th>
                        <th>Total Counts</th>
                        <th>Orthogroup</th>
                        <th>Module Count</th>
                        <th>Unique Modules</th>
                        <th>Unique GO Terms</th>
                        <th>Ortho Count</th>
                        <th>InterPro ID</th>
                        <th>InterPro Description</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <!-- Additional DataTables JS files -->
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.colVis.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>

    <script>
        const BASE_URL = "{{ BASE_URL }}";

        var table;

        $(document).ready(function() {
            function getParameterByName(name) {
                var url = window.location.href;
                name = name.replace(/[[]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }

            var speciesFilterJson = getParameterByName('species_filter');
            var initialSpeciesFilter = [];

            if (speciesFilterJson) {
                try {
                    initialSpeciesFilter = JSON.parse(speciesFilterJson);
                } catch (e) {
                    console.error("Error parsing species_filter:", e);
                }
            }

            console.log("Initial Species Filter:", initialSpeciesFilter);

            table = $('#browserRes').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": async function(data, callback, settings) {
                    try {
                        const response = await fetch(BASE_URL + "/api/data", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                ...data,
                                species_filter: JSON.stringify(initialSpeciesFilter),
                                table_name: "{{ BROWSER_DB }}"
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const json = await response.json();

                        callback({
                            draw: data.draw,
                            recordsTotal: json.recordsTotal,
                            recordsFiltered: json.recordsFiltered,
                            data: json.data
                        });
                    } catch (error) {
                        console.error("Error loading data for DataTables:", error);
                        callback({
                            draw: data.draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                },
                "columns": [
                    { "data": "species", autoToggle: true },
                    { "data": "transcript", autoToggle: true },
                    { "data": "modulecolors", autoToggle: true },
                    { "data": "modulelabels", autoToggle: false },
                    { "data": "go_terms", autoToggle: true },
                    { "data": "total_counts", autoToggle: false },
                    { "data": "ortho_id", autoToggle: true },
                    { "data": "module_count", autoToggle: false },
                    { "data": "unique_modules", autoToggle: false },
                    { "data": "unique_go_terms", autoToggle: false },
                    { "data": "ortho_count", autoToggle: false },
                    { "data": "ipr_id", autoToggle: true },
                    { "data": "ipr_desc", autoToggle: true }
                ],
                responsive: true,
                dom: 'Bfrtip',
                lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                buttons: [
                    {
                        extend: 'colvis',
                        columns: ':gt(1)',
                        text: 'Column Visibility'
                    },
                    {
                        text: 'Download Table',
                        action: async function (e, dt, node, config) {
                            try {
                                // Get the current DataTables parameters
                                var params = dt.ajax.params();

                                // Include species_filter in the params
                                if (Array.isArray(initialSpeciesFilter)) {
                                    params.species_filter = JSON.stringify(initialSpeciesFilter);
                                }

                                // Get the list of visible columns
                                var visibleColumns = [];
                                dt.columns().every(function (index) {
                                    if (dt.column(index).visible()) {
                                        // Get the data key for the column
                                        var columnData = dt.settings()[0].aoColumns[index].data;
                                        visibleColumns.push(columnData);
                                    }
                                });
                                params.visible_columns = visibleColumns;

                                // Fetch all data from the server
                                const response = await fetch(BASE_URL + '/api/export_data', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(params)  // Send parameters correctly as JSON
                                });

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const blob = await response.blob();

                                // Download the TSV file
                                var link = document.createElement('a');
                                link.href = window.URL.createObjectURL(blob);
                                var filename = prompt('Enter file name') || 'filtered_export.tsv';
                                link.download = filename.endsWith('.tsv') ? filename : filename + '.tsv';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            } catch (error) {
                                console.error("Error exporting filtered data:", error);
                            }
                        }
                    }
                ],
                columnDefs: [
                    { responsivePriority: 1, targets: 0 },
                    { responsivePriority: 2, targets: 1 },
                    { targets: [0, 1], visible: true, searchable: true, orderable: true },  // Ensure the first two columns are always visible
                    {
                        targets: [4, 11, 12],
                        render: function (data, type, row) {
                            if (type === 'display' && data && data.length > 30) {
                                return '<span class="d-inline-block text-truncate" style="max-width: 200px;">' + data + '</span>';
                            }
                            return data || '';
                        }
                    },
                    { targets: [2, 3, 5, 7, 8, 9, 10], visible: false }
                ],
                initComplete: function() {
                    toggleEmptyColumns(this.api());

                    $('#browserRes').on('draw.dt', function() {
                        toggleEmptyColumns(table);
                        sendHeight();
                    });

                    $('#browserRes').on('responsive-display.dt', function(e, datatable, row, showHide) {
                        sendHeight();
                    });
                }
            });

            table.buttons().container()
                .appendTo('#browserRes_wrapper .col-md-6:eq(0)');

            window.addEventListener('message', function(event) {
                if (event.data.type === 'getTableParams') {
                    var params = table.ajax.params();

                    if (initialSpeciesFilter && Array.isArray(initialSpeciesFilter)) {
                        params.species_filter = JSON.stringify(initialSpeciesFilter);
                    }

                    console.log("Sending table params with species filter:", params);
                    event.source.postMessage({ type: 'tableParams', data: params }, event.origin);
                }
            });

            window.addEventListener('message', function(event) {
                if (event.data.type === 'goTerm') {
                    var goTerm = event.data.value;

                    var searchInput = document.querySelector('input[type="search"]');
                    if (searchInput) {
                        searchInput.value = goTerm;
                        $(searchInput).trigger('input');
                    }
                }
            });

            function toggleEmptyColumns(api) {
                api.columns().every(function() {
                    var column = this;
                    // Get the column settings (including custom properties)
                    var colSettings = column.settings()[0].aoColumns[column.index()];
                    // Skip if autoToggle is explicitly disabled
                    if (colSettings.autoToggle === false) {
                        return;
                    }
                    // Check if all values in the column are empty (for the current page)
                    var isEmpty = column.data().toArray().every(function(value) {
                        return value === null ||
                            value === undefined ||
                            (typeof value === 'string' && value.trim() === '');
                    });
                    // Hide the column if it is empty, otherwise show it
                    column.visible(!isEmpty);
                });
            }

            function sendHeight() {
                var height = document.body.scrollHeight;

                if (window.frameElement && window.frameElement.id) {
                    try {
                        window.parent.postMessage({ type: 'resizeBrowser', target: window.frameElement.id, height: height }, '*');
                    } catch (error) {
                        console.error('Error sending message:', error);
                    }
                } else {
                    console.warn('No frameElement or missing id. Skipping height message.');
                }
            }

            setInterval(sendHeight, 500);
            sendHeight();
        });

        $('#browserRes').show();
    </script>

</body>
</html>
